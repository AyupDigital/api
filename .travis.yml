language: php

php:
  - 7.2

services:
  - mysql
  - redis-server

addons:
  apt:
    sources:
      - mysql-5.7-trusty
    packages:
      - mysql-server

dist: trusty

sudo: required

cache:
  directories:
    - vendor
    - node_modules

install:
  - composer self-update
  - composer install --no-interaction
  - npm install
  - npm run prod

before_script:
  - cp .env.travis .env
  - php artisan key:generate
  - mysql -e 'create database cwk_testing;'
  - php artisan migrate --force --seed

script:
  - vendor/bin/phpcs
  - vendor/bin/phpunit

deploy:
  provider: cloudfoundry
  api: api.cloud.service.gov.uk
  username: matt@ayup.agency
  password:
    secure: "qsetVFLwrQybcKMyds3PrayEI46gwPame3rWqrYgp6LKMFQ65abbMA0mjnJfiY83lC6/13W4jr+QfmSOptkyxJTbvLMwXdI/daYzc5LW1gmJNKVsIGdHt174USfH7t3Z2tSjBvdUNidtm0EV/kgmzxGNgb8vLm9jOxgXuBosVFO/xNknRN2O/7IAiPWfmpZmTRC9cGHCf8TKdYpr+LgdiDgMUoQ2tMoK62+xrLidVwH0ZPEzFbrv0r8Fkhp75ngwAg5G+c82ZtZKYNyNrAwNfY7hpE+D5LnYuoqaEja032AFThOQIA83FVijuY8bhfl3CmsV5kdm4vrEkcKs6ZmlPWhx7CXwEmlX7xeYd0Jk9J+2nBGVfmJgUgYTM04ytc8LKAsqomPw6h6jUgtnyKmpmiyJlAWGau6ExBekde4FtlyxZZtXAUkYRbZphg76PMo3DJZ7kENLXOmCKVw7jA/FhgxSzQjHHu6S6PIFxJh7L/KQ27kr9TTtx66xIrQplAKLYcEgZQ5yFLgo/ZuW/NLceVUI2P5TKF5hmuwmoXW7T/DDnOeC6b6ImnF5IowXYRD/oTt2B4Ll6m7g2I0u+PYHS1EZSy1K8undMCf/8Ant74364nd6HvQBFrp7dUjYWiQ2kxu6/vjqo9kIjdvATP2I8UpXywVbRegs0e7KBrXk/OU="
  organization: kingston-council-digital-design
  space: connectwellkingston-dev
  on:
    repo: RoyalBoroughKingston/cwk-api
    branch: develop
